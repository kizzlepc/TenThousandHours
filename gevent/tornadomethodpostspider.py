import time
from datetime import timedelta
from tornado import httpclient, gen, ioloop, queues
import random
import hashlib
import codecs

class AsyMethodPostSpider(object):
    def __init__(self, url, params, concurrency):
        self.parseJS = 'http://192.168.100.81:8050'
        self.wait = 10
        self.url = '%s/render.html?url=%s&wait=%s'%(self.parseJS, url, self.wait)
        self.params = params
        self.concurrency = concurrency
        self._q = queues.Queue()
        self._fetching = set()
        self._fetched = set()
 
    def proxy(self):
       return "http://192.168."+random.choice(['10', '11', '13', '14'])+"."+str(random.randrange(2,254))+":80"  

    def md5_str(self, _str):
        strs = str(_str)
        m = hashlib.md5(strs.encode('utf8'))
        return m.hexdigest()  
      
    @gen.coroutine
    def handle_data(self, response):
        md5_url = self.md5_str(response.request.url)
        (lambda f,d:(f.write(d), f.close()))(codecs.open('D:\\gongshang\\itempage\\'+response.request.url.split('http://')[2].split('.')[0]+'_'+md5_url+'.item','w', encoding='utf8'), response.body.decode('utf8'))
        print('打印结果：url:%s, body:%s'%(response.request.url, response.body))

    @gen.coroutine
    def method_post(self, url, req_body):
        try:
            headers = {'content-type': 'application/json',}
            response = yield httpclient.AsyncHTTPClient().fetch('%s&proxy=%s'%(url, self.proxy()), method='POST', headers=headers, body=req_body)
            print('POST请求完成： %s' % url)
        except Exception as e:
            print('POST请求错误: %s , 请求参数：%s' % (e, req_body))
            raise gen.Return('')
        raise gen.Return(response)

    @gen.coroutine
    def _run(self):
        start = time.time()
        @gen.coroutine
        def fetch_url():
            req_body = yield self._q.get()
            try:
                if req_body in self._fetching:
                    return

                print('post参数： %s' % req_body)
                self._fetching.add(req_body)
                response = yield self.method_post(self.url, req_body)
          
                if response:
                    yield self.handle_data(response)
                    self._fetched.add(req_body)
                else:
                    self._fetching.remove(req_body)
                    yield self._q.put(req_body)


            finally:
                self._q.task_done()

        @gen.coroutine
        def worker():
            while True:
                yield fetch_url()

        for param in self.params:
            yield self._q.put(param)

        for _ in range(self.concurrency):
            worker()
        yield self._q.join(timeout=timedelta(seconds=300))   
        assert self._fetching == self._fetched
        print('POST完成共用： %d 秒, 完成请求POST次数: %s.' % (time.time() - start, len(self._fetched)))

    def post(self):
        io_loop = ioloop.IOLoop.current()
        io_loop.run_sync(self._run)


def main():
    argBusExcepUrl = "/%7BEAC145F78DA7B47A61D3EFC5DED40872C061BAA18B2A2090143E72C0E2418F54D7C3E8F389A3FD8511ADE04CE360CC58CD4EE26AAB13AB90AB90AB3E913291AAEA7F7913861B2CFD52BB70EE7B11DAEDADAB3EA3A526B825F469A20B7BA7A8C8-1521212283048%7D";
    
    argBranchBusExcepUrl = "/%7B1A31B5077D57448A91231F352E24F88230914A517BDAD060E4CE823012B1034F456E1EBD73A82B3F140F755F0179ED511CB01F9C30A431B21E9657EF576C576C57C26DCE6D56168385EF7AE7D001AE478C1287ED26115157C25F59DA44D908955EF7875B5434-1521212283048%7D";
    
    IllInfoUrl = "/%7BF0DB5FED97BDAE607BC9F5DFC4CE1268DA7BA0BB91303A8A0E2485E585C8C272F6DC82FA6ED29F339C1FB327B2319D15D46CD4EFD4EFD441EE4DEED59500066CF96453822DC40F91046EA592D2D441DCDA59C75A8B16DD7404D8D7B7-1521212283048%7D";
    
    spotCheckInfoUrl = "/%7B9EB53183F9D3C00E15A79BB1AAA07C06B415CED5FF5E54E4604A91EB6FB31C6C775CB3FEF444C0EAB4CC58E4A905AA2985118407AB23E25AE2D9E2D9E277D87BD8E3A336305ACF5265B41BF239A7325893A4E4E277EAEC6FF16CBD20EB4232EEE181-1521212283048%7D";
    
    judiciaryStockfreezePersonUrl = "/%7B240F8B3943697AB4AF1D210B101AC6BC0EAF746F45E4EE5EDAF09F51EF4E65C4883A0634E86C47A818AAB1AA6378263D8F54D0DAF0AED642FEB31FB0339F0B9E1DB139F840F8C3F8C3F86DC261C2F9B92C2A40D5487FAE01E823BD284289BEFEF86DF0F675EB76A73AF15828F4FB9B-1521212283048%7D";
    
    judiciaryStockfreezeDetailUrl = "/%7BA88307B5CFE5F6382391AD879C964A308223F8E3C96862D2567C13DD63C2E94804B68AB864E0CB2494263D26EFF4DE80F86CD09D319E1DB125B0339F17D66ED6EDD6EDD643EC4FECD79702046EFB6651802FC60D93066CA790D0D643DED85BC5588914DF7606DAD5B5-1521212283048%7D"
    
    judiciaryAltershareholderUrl = "/%7B143FBB0973594A849F2D113B202AF68C3E9F445F75D4DE6EEAC0AF61DF7E55F4B80A36A8C8140FBD66165AE8F3830767D9C2705A047CE85419B51A9935A134B71B9352EA5269526952C768CB6853138680EA7FE2D504AB42891782E823145452C75A5CDF41DC0D905BF2825E5131-1521212283048%7D";
    
    insInvinfoUrl = "/%7BB89217A4DFF4E6293380BD968C875A219232E8F2D97972C3466DCDC61CBCB746E6ED5CD9F2ADD441FCB01DB3319C099D1FB23BFB42FBC1FBC1FB6FC163C1FBBA2E2942D64A7CAC02EA20BF2B408ABCFDFA6EF2F577E874A438F25A2BF6F899-1521212283049%7D";
    
    insInvAlterStockinfoUrl = "/%7BD0FA7FCCB79C8E415BE8D5FEE4EF3249FA5A809AB1111AAB2E05A5AE743833C25D3CE1FB487BA62309E7ABA01194BFE0990CB1FD50FE7CD144D052FF76B60FB68CB68CB6228C2E8CB6F763640F9B0731E14FA76DF2660DC7F1B0B723BFB83AA539E975BF1766BBB5D4-1521212283049%7D";
    
    insAlterstockinfoUrl = "/%7B1A30B5067D56448B91221F342E25F88330904A507BDBD061E4CF6F64BE21409D8734EE33B69C72D2D968EDC699E075C884298705A83DA92B860FCF76CFF5CFF5CF5BF557F5CF8E1A1D76E27E489836DE148B1F74BE88C9CE5AC6C143DC40900CC66E1FC2CCAD-1521212283049%7D";
    
    insLicenceinfoUrl = "/%7BAF8500B3C8E3F13E2497AA819B904D368525FFE5CE6E65D4517ADAD10B06A68C969DB7AD0D06B73219463FAA175BF658DA77E276F459D010A9102A102A10842A882A1051C5C2A93DA19747E901CB54C0AB6157161185191E9C039F4FD319B1C01D1372-1521212283049%7D";
    
    insProPledgeRegInfoUrl = "/%7B4C66E3502B0012DDC77449627873AED566C61C062D8D8637B2993932E8B70481DEBFA51A39235A40632F2495103B641D883579D47AF855C054D67BF2328B3208320832A608AA083273E7E08B1F83B565CB23E976E28943753433A73B3CBE21BD6DF13B93E23F3150-1521212283049%7D";
    
    proPledgeRegInfoUrl = "/%7B5872F7443F1406C9D3605D766C67BAC172D2081239999223A68DF645C09FFEE45B78621B01226E65D4517A255CC97438953BB9148115973AB373CA7349734973E749EB497332A6A1CA5EC2F4248A62A837A3C802347572E67A7DFF60FC2CB07AD2A37E7011-1521212283049%7D";
    
    trademarkInfoUrl = "/%7BA2880DBEC5EEFC33299AA78C969D403B8828F2E8C36368D95C77AA1954EBF1FFB201EFC49BE277CA862B8507AA3FAB29840DCD74CDF7CDF7CD59F755F7CD8C181F74E07C4A9A34DC16891D76BC8ACBCC58C4C341DE42920EC46C1DC0CEAF-1521212283049%7D";
    
    insPunishmentinfoUrl = "/%7B3C1693205B7062ADB70439120803DEA516B66C765DFDF647C2E9494298C70803A37908061C17CA6A61D0557E2158CD703C913FBD108511933EB777CE774D774D77E34DEF4D7736A2A5CE5AC6F0208E66AC33A7CC06307176E27E79FB64F828B47ED6A77A7415-1521212283049%7D";
    
    shareholderUrl = "/%7B94BE3B88F3D8CA051FAC91BAA0AB760DBE1EC4DEF5555EEF6A419BEAA7140E7FFA9B243E8DA6F98015A8E449E765C85DC94BE66FAF16AF95AF95AF3B953795AFEE7A7D16821E28F856BE74EB7F14DEE8A9AE3AA6A123BC20F06CA60E7FA2ACCD-1521212283049%7D";
    
    shareholderDetailUrl = "/%7BCFE560D3A883915E44F7CAE1FBF02D56E5459F85AE0E05B4311AC0B1FC4F5524A1C07F65D6425885C86809227D04912C60CD63E14CD94DCF62EB2B922B112B112BBF11B3112B6AFEF992069AAC7CD23AF06FFB905A6C2D2ABE2225A738A474E8228AFB262849-1521212283049%7D";
    
    alterInfoUrl = "/%7B6842C7740F2436F9E3506D465C578AF142E2382209A9A21396BDF0914C56E5CE91E87DC08C218F0DA035A1238E07C77EC7FDC7FDC753FD5FFDC78612157EEA7640903ED61C83177CB680C1C652CEC94BD4489804CE6617CAC4A5-1521212283049%7D";
    
    gtAlertInfoUrl = "/%7B614BCE7D062D3FF0EA59644F555E83F84BEB312B00A0AB1A9FB4974AD5B4AE1DC0EBB4CD58E5A904AA2885108406AB22E25BE2D8E2D8E276D87AD8E2A337305BCF5365B51BF339A6325993A5E4E377EBEC6EF16DBD21EB4332EFE180-1521212283049%7D"
    
    keyPersonUrl = "/%7BDAF075C6BD96844B51E2DFF4EEE53843F0508A90BB1B10A1240FE1FBC6998330EA6F644F1069FC410DA00E8C21B420A20F8646FF467C467C46D27CDE7C46079394FF6BF7C111BF579D0296FD37014047D34F48CA55C919854FE7964B4524-1521212283049%7D";
    
    gtKeyPersonUrl = "/%7B1E34B1027952408F95261B302A21FC8734944E547FDFD465E0CBE835415B663923904ACFC4EFB0C95CE1AD00AE2C81148002AF26E65FE6DCE6DCE672DC7EDCE6A733345FCB5761B11FF73DA2365D97A1E0E773EFE86AF569B925EF4736EBE584-1521212283049%7D";
    
    branchUrl = "/%7B4862E7542F0416D9C3704D667C77AAD162C2180229898233B69DE5561B103A4B603F46D36E228F21A30E9B0F8D20A969D06953695369FD53F1536928BCBBD044D8EE3E9078B22DB9D2182E6F68FC6067E57AE636AA60C8B9646A0B-1521212283049%7D";
    
    branchUrlAll = "/%7B143EBB0873584A859F2C113A202BF68D3E9E445E75385938747FCE4B6018ABE6EDC7B6294829656EDF5A712E57C27F339E30B21F8A1E9C31B878C17842784278EC42E0427839ADAAC155C9FF2F8169A33CA8C3093F7E79ED7176F46BF727BB71D9A8757B1A372D26FB043942587DC4-1521212283049%7D";
    
    liquidationUrl = "/%7B1E34B1027952408F95261B302A21FC8734944E547FDFD465E0CBAA0A18D777C88558F87D765D027BEE531FB21C9E33A632B01D9454ED546E546E54C06ECC6E54158186ED79E5D303AD458F1084EF25135255C15D5AD847DB0B975DF584595736-1521212283049%7D";
    
    allTrademarkUrl = "/%7B614BCE7D062D3FF0EA59644F555E83F84BEB312B004D2C4D010ABB3E15C87B3689939DD0638D1273125E55E4614A156CF94408A50B8924B125A70A8343FA4379437943D779DB7943029691FA6EF2C414BA52980793F832044542D64A4DCF50CC1C804AE2934E4021-1521212283049%7D";
    
    mortRegInfoUrl = "/%7B745EDB6813382AE5FF4C715A404B96ED5EFE243E15B5BE0F8AA1AF2A9944F7EDCE6E65D4517A255CC97438953BB9148115973AB373CA7349734973E749EB497332A6A1CA5EC2F4248A62A837A3C802347572E67A7DFF60FC2CB07AD2A37E7011-1521212283049%7D";
    
    mortRegDetailInfoUrl = "/%7BD0F97FCFB79F8E425BEBD5FDE4EC324AFA598099B1121AA82E060B8D3DE3534A6AD6CF115FFC9E3D35870129750F992768C66BEA44D245C46AE02399231A231A23B419B8192062F5F1990E91A477DA31F864F39B52672521B6292DAC30AF7CE32A81F32D2042-1521212283050%7D";
    
    stakQualitInfoUrl = "/%7B1F36B0007850418D94241A322B23FD8535964F567EDDD567E1C910CE806D7CB0FE9C3FE1424AF87E560A70E65817B914953BAD3ABB159F5CE65C655C655CCB66C7665F1D8A8EE671EEDB08A54E871B8CE42D185A5EC95652D34FD0039C55FE8C525F3D-1521212283050%7D";
    
    stakQualitDetailInfoUrl = "/%7BC9E066D6AE86975B42F2CCE4FDF52B53E3409980A80B03B1371FC61856BBAA66284AE9378B924C02A1C36068DA5C742852C47A359B36B7198F189937BD7EC47E477E477EE944E5447D3FA8ACC453CCF92A876CA539AEC60F3A787CEB7470F16DF221BE77DCAE707D1F-1521212283050%7D";
    
    otherLicenceInfoUrl = "/%7BFCD553E39BB3A26E77C7F9D1C8C01E66D675ACB59D3E3684022A48EBC2DBD3FAE34048FA7C540872E45A15BB169739AF38B9179D5EE45E675E675EC964C5645D1F888CE473ECD90AA74C85198EE62F1A585CCB5450D14DD2019E57FC8E505D3F-1521212283050%7D";
    
    otherLicenceDetailInfoUrl = "/%7B1930B6067E56478B92221C342D25FB833390495078DBD361E7CFAD0E273E361F06A5AD1F990E17C98724466E3248DE602F812CAD039502832DA764DE645D645D64F35EFF5E6725B2B6DE49D6E3309D76BF23B4DC15206266F16E6AEB77E83BA46DC6B46A6705-1521212283050%7D"
    
    assistUrl = "/%7B73EF5DEF4C65170E2637FBE2526C44E7EF5DDBF3BD64BD1EC719565EEC6A421E64F24C03AD00812FB92EAF018B48F24871487148DF72D3724B099E9AF265FACF1CB15A930F98F0390C4E4ADD4246C75BC4178841EA98464B29-1521212283050%7D"
    
    InsStockAlterModelUrl = "/%7B0F26A0106840519D84340A223B33ED9525865F466E2042206F67D5537BD8D009464EBC20429C853505DB5D74995ADC60791B336F15833D72DC71F05EC85FDE70FA39833900390039AE03A2033A78EFEB83148BBE6DC02BE27EE981487D3F3BAC3337B62AB566F9309BE9373A58-1521212283050%7D"
    
    shareHolderAll = "/%7B1138BE0E765E4F839A2A143C252DF38B3B984158703E5C3E7179CB4D65BCCE8030295BDDBF031AAA82DEA4328CC36DC041EF79EE6FC14B883288B188B1881FB213B28BC95E5A32A53A0FDC719A53CF5830F9CC8E8A1D8286079B04D748812A58868BE9C7DED608F4CAB2AB8D37-1521212283050%7D"
    
    alterAllUrl = "/%7BB39A1CACD4FCED213888B69E878F5129993AE3FAD29CFE9CD3DB69EFC789EB351D413BAD135CF25FDE70E671F05ED417AD172E172E17802D8C2D1456C1C5AD3AA59043EE05CC50C7AF66531115821D1998049B48D71EB5C7191476584149976B552D3412A8-1521212283050%7D"
    
    licenceAllUrl = "/%7B86AF2999E1C9D8140DBD83ABB2BA641CAC0FD6CFE7A9CBA9E6EE5CDAF290331A030B223B134F35A31D52FC51D07EE87FFE50DA19A319201920198E2382231A58CFCBA334AB9E4DE00BC25EC9A1685D1F1B8C1317960A9546D910BBC9171A78564F4799655B233A1CA6-1521212283050%7D"
    
    branchAllUrl = "/%7B173EB808705849859C2C123A232BF58D3D9E475E76385A38777FCD4B6318A8E6EEC7B5294B29666EDC5A722E54C27C339D30B11F891E9F31BB78C27841784178EF42E3427B39AEAAC255CAFF2C816AA33FA8C0093C7E7AED7276F76BF427B871DAA8767B19372E26F8043A425B7DC7-1521212283050%7D"
    
    punishmentAllUrl = "/%7BB29B1DADD5FDEC203989B79F868E5028983BE2FBD39DFF9DD2DA68EEC6BE727AA3D1DCC5CD133B671D8B357AD479F856C057D678F2318B3108310831A60BAA0B3270E7E38B1C83B665C823EA76E18940753733A43B3FBE22BD6EF13893E13F32507E676FB14D730B12348E-1521212283050%7D"
    
    StakqualitAllUrl = "/%7B5B72F4443C1405C9D0605E766F67B9C171D20B123A7416743B3381072FF628668B9A56187AD9072F73099F216EC06DEC42D443C26CE6259F251C251C25B21FBE1F2664F3F79F0897A271DC37FE62F59D54612327B02F2BAA36A97AE52C87F52B26446A737BA559671F06209A-1521212283050%7D"
    
    MortregAllUrl = "/%7B7951D6671E3727EAF2437C554D449BE253F12931185734571910A3240D018637E859416049146FF84709A60A8A25B224A40B8042F9427A427A42D478D87840039590F96FF1C517BB51990492FB33074441D7494CCC51CF1D834BE1924D41220D151CC33E01786047FC-1521212283051%7D"
    
    toSimpleCancelInfoAndObjectionUrl = "/%7B723D8E3D9FB7C4DCF5E5283081BE97353C8F0821F95B572E4D557C541B123A224168EF95F9E1C916B4333A134E35A21D53FC50D07FE87EFE51DA18A318201820188E2282221A59CFCAA335AB9F4DE10BC35EC8A1695D1E1B8D1316960B9547D911BBC8171B78574F4699645B223A1DA6-1521212283051%7D"
    
    simpleCancelUrl = "/%7BFED651E099B0A06D75C4FBD2CAC31C65D476AEB69F3D34870029F1535F26455DF1BEB79F87E4CD90EB7CC38D228E0EA136A0208F04C67DC6FEC6FEC650FC5CFCC48711147DEB7541933FD51D80167FB783C0C553CDC848D54B9907CF6516C9C5A6-1521212283051%7D";
    
    isLoginUrl = "/%7B2B0384354C6575B8A0112E071F16C9B001A37B634AE8E152D5FC5E86890E2F8D842E5D828EED-1521212283051%7D";
    
    checkUserInfoUrl = "/socialuser-checkUserInfo.html";
    
    objectionWriteUrl = "/%7B84CB78CB6941322A0313DEC6774861C3CA79FED70FADA1D8BBA38AA2EDE4CCD4B79E19630F173FE042C5CCA312B06F775E0378EF501EB11D9D32A533B31C9755EE556D556D55C36FCF6F57148287EE78E6D200AC468E1385EC24105356C05E5BDB46D80A945CF6855A56351A020BD429166F7750EB-1521212283051%7D";
    
    addNewHistoryScanUrl = "/socialuser-addNewHistoryScan-PROVINCENODENUM110000DCBB0FD56D324C87AD672F5D35EA3437.html?entType=1";
    
    showSubcribeUrl = "/%7B4860E7562F0616DBC3724D647C75AAD362C01800298B8231B69F4734B3C1F03D476FDE7C061E376A11863977D874F45BCC5ADA75FE3C873C043C043CAA06A6063E7DEBEE87118FBB69C52FE77AEC854D793A3FA93732B22FB163FD359FEC333F5C-1521212283051%7D";
    
    updateSubModulesInfoUrl = "/%7BB29D1DABD5FBEC26398FB7998688502E983DE2FDD37678CC4C62A8D66C24FCE3D51F62A7279D57332CF3BAB400802D59818AEEC6B80EABD59C26065C20B00841E942C56DFD6CEB43CF0AB60A350A350A9B3097300F4BDAD8B627BE8D58F31ED14BDAB47B480C0E9F060483198055CC03-1521212283052%7D";
    
    insertUserAttentionUrl = "/%7B446BEB5D230D1AD0CF79416F707EA6D86ECB140B25808E3ABA94313FE0FF49911DC2DD6BF129F1EEE0389D1D13BECA12197D552B9D38460FB595CFB3239BD27AD156FE6EFF78D05C992599A699A69908A304A39CD8494B25B42D1ECB608D42D84927E8DB9F9D0C9597108A13C65F9089434DE8371851EBCB40FC40FCC3FCC3FC112E1DA19EA174ED74D3CAD5DB03ABE3E8F7D70D689A666BA87A4AC41E1326F498E8CAF42FFD3646D3D7CF5ADB40B383F822D714CE9C140DBBA4822AAA8A368AB50936DBE4DBE827BE6B05078C959B1BA1BE16DCD7F74BF7C8F7C8F7EEF1FF27DDE59B84A418-1521212283052%7D";
    
    getAttentionEffectiveUrl="/%7B9EB13187F9D7C00A15A39BB5AAA47C02B411CED1FF5A54E0604E6877AF35ED352A24FC59D9D750E4504F60B81DE9F65B2FF7FC98B0CE78DDA306BC9CC6BA2A92DB73D85FF767F671D955902C90AF90AF9001AA0DAA95D140422CBD2417C269844BD1402EE1D29694059C9E19831ACF5699805FD8C810B838829D93595272CE724D724D72-1521212283052%7D";
    
    deleteAttentionByPripidUrl="/%7B200F8F3947697EB4AB1D250B141AC2BC0AAF706F41E4EA5EDEF04A55312EF6E973AB736C62BA1F9F91360E54E247399C268BFF272C48601EA80D73D66C4C166AFA420BA3088F27B726A1098540FC407F407F40D17ADD7A45019092FC6DF4C712B9549B0190FE31024644D54C4EC953CA1F8649508F0818C068E8524D438982A21EA29DA29DA2-1521212283052%7D";
    
    getDrRaninsResUrl="/%7B69ADC69B0ECB3716E2BF6CA95DB88B1E430D39CD0846A3FC9752C4993ADF1B8441F0671C4FEDAEEE82C1BAC0ACEF88A6F1A672A672A67232481FC742304ACFAF77D80CD8B8D4B86C85F78652D7A571A92C12C612721E58C7F4149B-1521218558183%7D";
    
    url ='http://bj.gsxt.gov.cn'+getDrRaninsResUrl 
    params = ['{"draw":"2","start":"0","length":"5"}',]
    s = AsyMethodPostSpider(url, params, 10)
    s.post()

if __name__ == '__main__':
    main()
